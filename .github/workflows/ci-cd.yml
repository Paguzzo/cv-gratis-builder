name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: Lint e validação de código
  lint:
    name: Lint e Validação
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependências
      run: npm ci

    - name: Executar ESLint
      run: npm run lint
      continue-on-error: true

  # Job 2: Security audit
  security:
    name: Auditoria de Segurança
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependências
      run: npm ci

    - name: Audit de vulnerabilidades
      run: npm audit --production --audit-level=high
      continue-on-error: true

    - name: Verificar secrets expostos
      run: |
        echo "Verificando por secrets expostos..."
        ! git log --all --full-history --pretty=format:"%H %s" -- .env server/.env | head -1

  # Job 3: Build da aplicação
  build:
    name: Build da Aplicação
    runs-on: ubuntu-latest
    needs: [lint, security]

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Instalar dependências
      run: npm ci

    - name: Build para produção
      run: npm run build
      env:
        # Variáveis de ambiente públicas (não sensíveis)
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}

    - name: Verificar tamanho do bundle
      run: |
        echo "Tamanho do bundle:"
        du -sh dist/
        du -h dist/assets/*.js | sort -h

    - name: Upload do build
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  # Job 4: Build do backend
  build-backend:
    name: Build do Backend
    runs-on: ubuntu-latest
    needs: [security]

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Instalar dependências do backend
      run: |
        cd server
        npm ci

    - name: Audit do backend
      run: |
        cd server
        npm audit --production --audit-level=high
      continue-on-error: true

  # Job 5: Deploy para staging (apenas em push para develop)
  deploy-staging:
    name: Deploy para Staging
    runs-on: ubuntu-latest
    needs: [build, build-backend]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.curriculogratisonline.com

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/

    - name: Deploy para Staging
      run: |
        echo "Deploy para staging seria executado aqui"
        echo "Integre com Vercel, Netlify, AWS, etc."
        # Exemplo: vercel --prod --token=${{ secrets.VERCEL_TOKEN }}

  # Job 6: Deploy para produção (apenas em push para main/master)
  deploy-production:
    name: Deploy para Produção
    runs-on: ubuntu-latest
    needs: [build, build-backend]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    environment:
      name: production
      url: https://curriculogratisonline.com

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/

    - name: Deploy para Produção
      run: |
        echo "Deploy para produção seria executado aqui"
        echo "IMPORTANTE: Configurar secrets no GitHub antes do deploy"
        # Exemplo: vercel --prod --token=${{ secrets.VERCEL_TOKEN }}

    - name: Notificar sucesso
      run: |
        echo "✅ Deploy concluído com sucesso!"
        echo "URL: https://curriculogratisonline.com"
